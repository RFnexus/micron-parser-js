class MicronParser{constructor(e=!0,t=!0){this.darkTheme=e,this.enableForceMonospace=t,this.DEFAULT_FG_DARK="ddd",this.DEFAULT_FG_LIGHT="222",this.DEFAULT_BG="default",this.enableForceMonospace&&this.injectMonospaceStyles();try{"undefined"==typeof DOMPurify&&console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}catch(e){console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}this.SELECTED_STYLES=null,this.STYLES_DARK={plain:{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"222",bg:"bbb",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"999",bold:!1,underline:!1,italic:!1},heading3:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1}},this.STYLES_LIGHT={plain:{fg:this.DEFAULT_FG_LIGHT,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"aaa",bold:!1,underline:!1,italic:!1},heading3:{fg:"222",bg:"ccc",bold:!1,underline:!1,italic:!1}},this.darkTheme?this.SELECTED_STYLES=this.STYLES_DARK:this.SELECTED_STYLES=this.STYLES_LIGHT}injectMonospaceStyles(){var e;document.getElementById("micron-monospace-styles")||((e=document.createElement("style")).id="micron-monospace-styles",e.textContent=`
            .Mu-nl {
                cursor: pointer;
            }
            .Mu-mnt {
                display: inline-block;
                width: 0.6em;
                text-align: center;
                white-space: pre;
                text-decoration: inherit;
            }
            .Mu-mws {
                text-decoration: inherit;
                display: inline-block;
            }
        `,document.head.appendChild(e))}static formatNomadnetworkUrl(e){return"nomadnetwork://"+e}convertMicronToHtml(e){let t="";var l,i={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}};for(l of e.split("\n")){var n=this.parseLine(l,i);if(n&&0<n.length)for(var a of n)t+=a.outerHTML;else n&&0===n.length||(t+="<br>")}try{return DOMPurify.sanitize(t,{USE_PROFILES:{html:!0}})}catch(e){return console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify ",e),'<p style="color: red;"> âš  DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify </p>'}}convertMicronToFragment(e){var t,l=document.createDocumentFragment(),i={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}};for(t of e.split("\n")){t=DOMPurify.sanitize(t,{USE_PROFILES:{html:!0}});var n=this.parseLine(t,i);if(n&&0<n.length)for(var a of n)l.appendChild(a);else n&&0===n.length||l.appendChild(document.createElement("br"))}return l}parseLine(e,l){if(0<e.length){if("`="===e)return l.literal=!l.literal,null;if(!l.literal){if("#"===e[0])return[];if("<"===e[0])return l.depth=0,this.parseLine(e.slice(1),l);if(">"===e[0]){let t=0;for(;t<e.length&&">"===e[t];)t++;l.depth=t;var i=e.slice(t);if(0<i.length){let e=null;var n="heading"+t,n=(e=this.SELECTED_STYLES[n]||this.SELECTED_STYLES.plain,this.stateToStyle(l)),i=(this.styleToState(e,l),this.makeOutput(l,i));return this.styleToState(n,l),i&&0<i.length?((n=document.createElement("div")).style.display="inline-block",n.style.width="100%",this.applyStyleToElement(n,e),a=document.createElement("div"),this.applySectionIndent(a,l),this.appendOutput(a,i,l),n.appendChild(a),[n,document.createElement("br")]):i&&0<i.length?(a=document.createElement("div"),this.applyAlignment(a,l),this.applySectionIndent(a,l),this.appendOutput(a,i,l),[a]):null}return null}if("-"===e[0])return 1===e.length?((n=document.createElement("hr")).style.all="revert",n.style.borderColor=this.colorToCss(l.fg_color),n.style.margin="0.5em 0.5em 0.5em 0.5em",n.style.boxShadow="0 0 0 0.5em "+this.colorToCss(l.bg_color),this.applySectionIndent(n,l),[n]):(i=e[1].repeat(250),(a=document.createElement("div")).style.whiteSpace="pre",a.textContent=i,a.style.width="100%",a.style.whiteSpace="nowrap",a.style.overflow="hidden",a.style.color=this.colorToCss(l.fg_color),a.style.backgroundColor=this.colorToCss(l.bg_color),this.applySectionIndent(a,l),[a])}var a,n=this.makeOutput(l,e);return n?(i=document.createElement("div"),this.applyAlignment(i,l),this.applySectionIndent(i,l),this.appendOutput(i,n,l),l.bg_color!==this.DEFAULT_BG?((a=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),a.style.width="100%",a.style.display="block",a.style.padding="0 2px",a.appendChild(i),[a]):[i]):(n=document.createElement("br"),l.bg_color!==this.DEFAULT_BG?((a=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),a.style.width="100%",a.style.height="1.2em",a.style.display="block",i=document.createElement("div"),this.applySectionIndent(i,l),i.appendChild(n),a.appendChild(i),[a]):[n])}return i=document.createElement("br"),l.bg_color!==this.DEFAULT_BG?((a=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),a.style.width="100%",a.style.height="1.2em",a.style.display="block",n=document.createElement("div"),this.applySectionIndent(n,l),n.appendChild(i),a.appendChild(n),[a]):[i]}applyAlignment(e,t){e.style.textAlign=t.align||"left"}applySectionIndent(e,t){t=2*(t.depth-1);0<t&&(e.style.marginLeft=.6*t+"em")}stateToStyle(e){return{fg:e.fg_color,bg:e.bg_color,bold:e.formatting.bold,underline:e.formatting.underline,italic:e.formatting.italic}}styleToState(e,t){null!=e.fg&&(t.fg_color=e.fg),null!=e.bg&&(t.bg_color=e.bg),null!=e.bold&&(t.formatting.bold=e.bold),null!=e.underline&&(t.formatting.underline=e.underline),null!=e.italic&&(t.formatting.italic=e.italic)}appendOutput(e,t,l){let i=null,n=null;var a,r=()=>{i&&(n&&n.bg!==this.DEFAULT_BG&&(i.style.display="inline-block",i.style.padding="0 2px"),e.appendChild(i),i=null,n=null)};for(a of t)if("string"==typeof a){var o=document.createElement("span");o.innerHTML=a,e.appendChild(o)}else if(Array.isArray(a)&&2===a.length){var[o,s]=a;this.stylesEqual(o,n)||(r(),i=document.createElement("span"),this.applyStyleToElement(i,o),n=o),i.innerHTML+=s}else if(a&&"object"==typeof a)if(r(),"field"===a.type){s=document.createElement("input");s.type=a.masked?"password":"text",s.name=a.name,s.setAttribute("value",a.data),a.width&&(s.size=a.width),this.applyStyleToElement(s,this.styleFromState(a.style)),e.appendChild(s)}else if("checkbox"===a.type){var c=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.name=a.name,d.value=a.value,a.prechecked&&d.setAttribute("checked",!0),c.appendChild(d),c.appendChild(document.createTextNode(" "+a.label)),this.applyStyleToElement(c,this.styleFromState(a.style)),e.appendChild(c)}else if("radio"===a.type){d=document.createElement("label"),c=document.createElement("input");c.type="radio",c.name=a.name,c.value=a.value,a.prechecked&&c.setAttribute("checked",!0),d.appendChild(c),d.appendChild(document.createTextNode(" "+a.label)),this.applyStyleToElement(d,this.styleFromState(a.style)),e.appendChild(d)}else if("link"===a.type){let t=a.url.replace("nomadnetwork://","").replace("lxmf://","");var p,h,u=a.url,g=document.createElement("a"),f=(g.href=u,g.title=u,[]),m={};let l=!1;if(a.fields&&0<a.fields.length){for(var y of a.fields)"*"===y?l=!0:y.includes("=")?([p,h]=y.split("="),m[p]=h):f.push(y);let e="";e=l?"*":f.join("|");var u=Object.entries(m);0<u.length&&(u=u.map(([e,t])=>e+"="+t).join("|"),t+=t.includes("`")?"|"+u:"`"+u),g.setAttribute("data-destination",""+t),g.setAttribute("data-fields",""+e)}else g.setAttribute("data-destination",""+t);g.classList.add("Mu-nl"),g.setAttribute("data-action","openNode"),g.innerHTML=a.label,this.applyStyleToElement(g,this.styleFromState(a.style)),e.appendChild(g)}r()}stylesEqual(e,t){return!e&&!t||!(!e||!t)&&e.fg===t.fg&&e.bg===t.bg&&e.bold===t.bold&&e.underline===t.underline&&e.italic===t.italic}styleFromState(e){return e}applyStyleToElement(e,t){var l,i;t&&(l=this.colorToCss(t.fg),i=this.colorToCss(t.bg),l&&"default"!==l&&(e.style.color=l),i&&"default"!==i&&(e.style.backgroundColor=i,e.style.padding="0 2px",e.style.display="inline-block"),t.bold&&(e.style.fontWeight="bold"),t.underline&&(e.style.textDecoration=e.style.textDecoration?e.style.textDecoration+" underline":"underline"),t.italic)&&(e.style.fontStyle="italic")}colorToCss(t){if(!t||"default"===t)return null;if(3===t.length&&/^[0-9a-fA-F]{3}$/.test(t))return"#"+t;if(6===t.length&&/^[0-9a-fA-F]{6}$/.test(t))return"#"+t;if(3!==t.length||"g"!==t[0])return null;{let e=parseInt(t.slice(1),10);isNaN(e)&&(e=50);t=Math.floor(2.55*e).toString(16).padStart(2,"0");return"#"+t+t+t}}makeOutput(e,t){if(e.literal)return"\\`="===t&&(t="`="),this.enableForceMonospace?[[this.stateToStyle(e),this.splitAtSpaces(t)]]:[[this.stateToStyle(e),t]];let l=[],i="",n="text",a=!1,r=0;var o=()=>{0<i.length&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(i)]):l.push([this.stateToStyle(e),i]),i="")};let s=0;for(;s<t.length;){var c,d=t[s];if(0<r)r--;else if("formatting"===n){switch(d){case"_":e.formatting.underline=!e.formatting.underline;break;case"!":e.formatting.bold=!e.formatting.bold;break;case"*":e.formatting.italic=!e.formatting.italic;break;case"F":t.length>=s+4&&(c=t.substr(s+1,3),e.fg_color=c,r=3);break;case"f":e.fg_color=this.SELECTED_STYLES.plain.fg;break;case"B":t.length>=s+4&&(c=t.substr(s+1,3),e.bg_color=c,r=3,o());break;case"b":e.bg_color=this.DEFAULT_BG,o();break;case"`":e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,n="text";break;case"c":e.align="center";break;case"l":e.align="left";break;case"r":e.align="right";break;case"a":e.align=e.default_align;break;case"<":o();var p=this.parseField(t,s,e);if(p){l.push(p.obj),s+=p.skip;continue}break;case"[":o();p=this.parseLink(t,s,e);if(p){l.push(p.obj),s+=p.skip;continue}}n="text"}else if(a)i+=d,a=!1;else if("\\"===d)a=!0;else{if("`"===d){if(s+1<t.length&&"`"===t[s+1]){o(),e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,s+=2;continue}o(),n="formatting",s++;continue}if("["===d){o();var h=this.parseLink(t,s,e);if(h){l.push(h.obj),s+=h.skip;continue}i+="["}else i+=d}s++}return 0<i.length&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(i)]):l.push([this.stateToStyle(e),i])),l}parseField(e,t,l){var i=t+1,n=e.indexOf("`",i);if(-1===n)return null;i=e.substring(i,n);let a=!1,r=24,o="field",s=i,c="",d=!1;if(i.includes("|")){i=i.split("|");let e=i[0];s=i[1],e.includes("^")?(o="radio",e=e.replace("^","")):e.includes("?")?(o="checkbox",e=e.replace("?","")):e.includes("!")&&(a=!0,e=e.replace("!","")),0<e.length&&(p=parseInt(e,10),isNaN(p)||(r=Math.min(p,256))),2<i.length&&(c=i[2]),3<i.length&&"*"===i[3]&&(d=!0)}var p=e.indexOf(">",n);if(-1===p)return null;i=e.substring(n+1,p),e=this.stateToStyle(l);let h=null;return{obj:h="checkbox"===o||"radio"===o?{type:o,name:s,value:c||i,label:i,prechecked:d,style:e}:{type:"field",name:s,width:r,masked:a,data:i,style:e},skip:p-t}}parseLink(e,t,l){var i=e.indexOf("]",t);if(-1===i)return null;var e=e.substring(t+1,i),n=e.split("`");let a="",r="",o="";if(1===n.length?(a="",r=e):2===n.length?(a=n[0],r=n[1]):3===n.length&&(a=n[0],r=n[1],o=n[2]),0===r.length)return null;""===a&&(a=r),r=MicronParser.formatNomadnetworkUrl(r),this.enableForceMonospace&&(a=this.splitAtSpaces(a));e=this.stateToStyle(l);return{obj:{type:"link",url:r,label:a,fields:o?o.split("|"):[],style:e},skip:i-t}}splitAtSpaces(e){let t="";var l=e.split(" ");for(let e=0;e<l.length;e++)t+="<span class='Mu-mws'>"+this.forceMonospace(l[e])+"</span>",e<l.length-1&&(t+=" ");return t}forceMonospace(e){let t="";var l;for(l of[...(new Intl.Segmenter).segment(e)].map(e=>e.segment))t+="<span class='Mu-mnt'>"+l+"</span>";return t}}export default MicronParser;