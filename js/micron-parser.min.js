class MicronParser{constructor(e=!0,t=!0){this.darkTheme=e,this.enableForceMonospace=t,this.DEFAULT_FG_DARK="ddd",this.DEFAULT_FG_LIGHT="222",this.DEFAULT_BG="default",this.enableForceMonospace&&this.injectMonospaceStyles();try{"undefined"==typeof DOMPurify&&console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}catch(e){console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}this.STYLES_DARK={plain:{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"222",bg:"bbb",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"999",bold:!1,underline:!1,italic:!1},heading3:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1}},this.STYLES_LIGHT={plain:{fg:this.DEFAULT_FG_LIGHT,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"aaa",bold:!1,underline:!1,italic:!1},heading3:{fg:"222",bg:"ccc",bold:!1,underline:!1,italic:!1}},this.SELECTED_STYLES=this.darkTheme?this.STYLES_DARK:this.STYLES_LIGHT}injectMonospaceStyles(){var e;document.getElementById("micron-monospace-styles")||((e=document.createElement("style")).id="micron-monospace-styles",e.textContent=`
            .Mu-nl {
                cursor: pointer;
            }
            .Mu-mnt {
                display: inline-block;
                width: 0.6em;
                text-align: center;
                white-space: pre;
                text-decoration: inherit;
            }
            .Mu-mws {
                text-decoration: inherit;
                display: inline-block;
            }
        `,document.head.appendChild(e))}static formatNomadnetworkUrl(e){return/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(e)?e:"nomadnetwork://"+e}parseHeaderTags(e){let t=null,l=null;var i;for(i of e.split("\n")){var n,a=i.trim();if(0!==a.length){if(!a.startsWith("#!"))break;!a.startsWith("#!fg=")||3!==(n=a.substring(5).trim()).length&&6!==n.length||(t=n),!a.startsWith("#!bg=")||3!==(n=a.substring(5).trim()).length&&6!==n.length||(l=n)}}return{fg:t,bg:l}}convertMicronToHtml(e){let t="";var l,i=this.parseHeaderTags(e),n=this.SELECTED_STYLES?.plain||{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG},n=i.fg||n.fg,i=i.bg||this.DEFAULT_BG,a={literal:!1,depth:0,fg_color:n,bg_color:i,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",default_fg:n,default_bg:i,radio_groups:{}};for(l of e.split("\n")){var r=this.parseLine(l,a);if(r&&0<r.length)for(var o of r)t+=o.outerHTML;else r&&0===r.length||(t+="<br>")}let s="";n&&"default"!==n&&(s+=`color: ${this.colorToCss(n)};`),i&&"default"!==i&&(s+=`background-color: ${this.colorToCss(i)};`),s&&(t=`<div style="${s}">${t}</div>`);try{return DOMPurify.sanitize(t,{USE_PROFILES:{html:!0}})}catch(e){return console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify ",e),'<p style="color: red;"> âš  DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify </p>'}}convertMicronToFragment(e){var t,l=document.createDocumentFragment(),i=this.parseHeaderTags(e),n=this.SELECTED_STYLES?.plain||{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG},n=i.fg||n.fg,i=i.bg||this.DEFAULT_BG,a={literal:!1,depth:0,fg_color:n,bg_color:i,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",default_fg:n,default_bg:i,radio_groups:{}},r=document.createElement("div"),n=(n&&"default"!==n&&(r.style.color=this.colorToCss(n)),i&&"default"!==i&&(r.style.backgroundColor=this.colorToCss(i)),e.split("\n"));for(t of n){t=DOMPurify.sanitize(t,{USE_PROFILES:{html:!0}});var o=this.parseLine(t,a);if(o&&0<o.length)for(var s of o)r.appendChild(s);else o&&0===o.length||r.appendChild(document.createElement("br"))}return l.appendChild(r),l}parseLine(e,l){if(0<e.length){if("`="===e)return l.literal=!l.literal,null;if(!l.literal){if("#"===e[0])return[];if("<"===e[0])return l.depth=0,this.parseLine(e.slice(1),l);if(">"===e[0]){let t=0;for(;t<e.length&&">"===e[t];)t++;l.depth=t;var i=e.slice(t);if(0<i.length){let e=null;var n="heading"+t,a={fg:this.darkTheme?this.DEFAULT_FG_DARK:this.DEFAULT_FG_LIGHT,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},n=(e=this.SELECTED_STYLES?.[n]?this.SELECTED_STYLES[n]:this.SELECTED_STYLES?.plain||a,this.stateToStyle(l)),a=(this.styleToState(e,l),this.makeOutput(l,i));return this.styleToState(n,l),a&&0<a.length?((i=document.createElement("div")).style.display="inline-block",i.style.width="100%",this.applyStyleToElement(i,e),n=document.createElement("div"),this.applySectionIndent(n,l),this.appendOutput(n,a,l),i.appendChild(n),[i,document.createElement("br")]):a&&0<a.length?(n=document.createElement("div"),this.applyAlignment(n,l),this.applySectionIndent(n,l),this.appendOutput(n,a,l),[n]):null}return null}if("-"===e[0])return 1===e.length?((i=document.createElement("hr")).style.all="revert",i.style.borderColor=this.colorToCss(l.fg_color),i.style.margin="0.5em 0.5em 0.5em 0.5em",i.style.boxShadow="0 0 0 0.5em "+this.colorToCss(l.bg_color),this.applySectionIndent(i,l),[i]):(a=e[1].repeat(250),(n=document.createElement("div")).style.whiteSpace="pre",n.textContent=a,n.style.width="100%",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.color=this.colorToCss(l.fg_color),l.bg_color!==l.default_bg&&"default"!==l.bg_color&&(n.style.backgroundColor=this.colorToCss(l.bg_color)),this.applySectionIndent(n,l),[n])}var i=this.makeOutput(l,e);return i?(a=document.createElement("div"),this.applyAlignment(a,l),this.applySectionIndent(a,l),this.appendOutput(a,i,l),l.bg_color!==l.default_bg&&"default"!==l.bg_color?((n=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),n.style.width="100%",n.style.display="block",n.appendChild(a),[n]):[a]):(i=document.createElement("br"),l.bg_color!==l.default_bg&&"default"!==l.bg_color?((n=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),n.style.width="100%",n.style.height="1.2em",n.style.display="block",a=document.createElement("div"),this.applySectionIndent(a,l),a.appendChild(i),n.appendChild(a),[n]):[i])}return a=document.createElement("br"),l.bg_color!==l.default_bg&&"default"!==l.bg_color?((n=document.createElement("div")).style.backgroundColor=this.colorToCss(l.bg_color),n.style.width="100%",n.style.height="1.2em",n.style.display="block",i=document.createElement("div"),this.applySectionIndent(i,l),i.appendChild(a),n.appendChild(i),[n]):[a]}applyAlignment(e,t){e.style.textAlign=t.align||"left"}applySectionIndent(e,t){t=2*(t.depth-1);0<t&&(e.style.marginLeft=.6*t+"em")}stateToStyle(e){return{fg:e.fg_color,bg:e.bg_color,bold:e.formatting.bold,underline:e.formatting.underline,italic:e.formatting.italic}}styleToState(e,t){null!=e.fg&&(t.fg_color=e.fg),null!=e.bg&&(t.bg_color=e.bg),null!=e.bold&&(t.formatting.bold=e.bold),null!=e.underline&&(t.formatting.underline=e.underline),null!=e.italic&&(t.formatting.italic=e.italic)}appendOutput(e,t,i){let l=null,n=null;var a,r=()=>{l&&(n&&n.bg!==i.default_bg&&"default"!==n.bg&&(l.style.display="inline-block"),e.appendChild(l),l=null,n=null)};for(a of t)if("string"==typeof a){var o=document.createElement("span");o.innerHTML=a,e.appendChild(o)}else if(Array.isArray(a)&&2===a.length){var[o,s]=a;this.stylesEqual(o,n)||(r(),l=document.createElement("span"),this.applyStyleToElement(l,o,i.default_bg),n=o),l.innerHTML+=s}else if(a&&"object"==typeof a)if(r(),"field"===a.type){s=document.createElement("input");s.type=a.masked?"password":"text",s.name=a.name,s.setAttribute("value",a.data),a.width&&(s.size=a.width),this.applyStyleToElement(s,this.styleFromState(a.style),i.default_bg),e.appendChild(s)}else if("checkbox"===a.type){var d=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.name=a.name,c.value=a.value,a.prechecked&&c.setAttribute("checked",!0),d.appendChild(c),d.appendChild(document.createTextNode(" "+a.label)),this.applyStyleToElement(d,this.styleFromState(a.style),i.default_bg),e.appendChild(d)}else if("radio"===a.type){c=document.createElement("label"),d=document.createElement("input");d.type="radio",d.name=a.name,d.value=a.value,a.prechecked&&d.setAttribute("checked",!0),c.appendChild(d),c.appendChild(document.createTextNode(" "+a.label)),this.applyStyleToElement(c,this.styleFromState(a.style),i.default_bg),e.appendChild(c)}else if("link"===a.type){let t=a.url.replace("nomadnetwork://","").replace("lxmf://","");var u,p,h=a.url,g=document.createElement("a"),f=(g.href=h,g.title=h,[]),b={};let l=!1;if(a.fields&&0<a.fields.length){for(var m of a.fields)"*"===m?l=!0:m.includes("=")?([u,p]=m.split("="),b[u]=p):f.push(m);let e="";e=l?"*":f.join("|");var h=Object.entries(b);0<h.length&&(h=h.map(([e,t])=>e+"="+t).join("|"),t+=t.includes("`")?"|"+h:"`"+h),g.setAttribute("data-destination",""+t),g.setAttribute("data-fields",""+e)}else g.setAttribute("data-destination",""+t);g.classList.add("Mu-nl"),g.setAttribute("data-action","openNode"),g.innerHTML=a.label,this.applyStyleToElement(g,this.styleFromState(a.style),i.default_bg),e.appendChild(g)}r()}stylesEqual(e,t){return!e&&!t||!(!e||!t)&&e.fg===t.fg&&e.bg===t.bg&&e.bold===t.bold&&e.underline===t.underline&&e.italic===t.italic}styleFromState(e){return e}applyStyleToElement(e,t,l="default"){var i,n;t&&(i=this.colorToCss(t.fg),n=this.colorToCss(t.bg),i&&"default"!==i&&(e.style.color=i),n&&"default"!==n&&t.bg!==l&&(e.style.backgroundColor=n,e.style.display="inline-block"),t.bold&&(e.style.fontWeight="bold"),t.underline&&(e.style.textDecoration=e.style.textDecoration?e.style.textDecoration+" underline":"underline"),t.italic)&&(e.style.fontStyle="italic")}colorToCss(t){if(!t||"default"===t)return null;if(3===t.length&&/^[0-9a-fA-F]{3}$/.test(t))return"#"+t;if(6===t.length&&/^[0-9a-fA-F]{6}$/.test(t))return"#"+t;if(3!==t.length||"g"!==t[0])return null;{let e=parseInt(t.slice(1),10);isNaN(e)&&(e=50);t=Math.floor(2.55*e).toString(16).padStart(2,"0");return"#"+t+t+t}}makeOutput(e,t){if(e.literal)return"\\`="===t&&(t="`="),this.enableForceMonospace?[[this.stateToStyle(e),this.splitAtSpaces(t)]]:[[this.stateToStyle(e),t]];let l=[],i="",n="text",a=!1,r=0;var o=()=>{0<i.length&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(i)]):l.push([this.stateToStyle(e),i]),i="")};let s=0;for(;s<t.length;){var d,c=t[s];if(0<r)r--;else if("formatting"===n){switch(c){case"_":e.formatting.underline=!e.formatting.underline;break;case"!":e.formatting.bold=!e.formatting.bold;break;case"*":e.formatting.italic=!e.formatting.italic;break;case"F":t.length>=s+4&&(d=t.substr(s+1,3),e.fg_color=d,r=3);break;case"f":e.fg_color=e.default_fg;break;case"B":t.length>=s+4&&(d=t.substr(s+1,3),e.bg_color=d,r=3,o());break;case"b":e.bg_color=e.default_bg,o();break;case"`":e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=e.default_fg,e.bg_color=e.default_bg,e.align=e.default_align,n="text";break;case"c":e.align="center";break;case"l":e.align="left";break;case"r":e.align="right";break;case"a":e.align=e.default_align;break;case"<":o();var u=this.parseField(t,s,e);if(u){l.push(u.obj),s+=u.skip;continue}break;case"[":o();u=this.parseLink(t,s,e);if(u){l.push(u.obj),s+=u.skip;continue}}n="text"}else if(a)i+=c,a=!1;else if("\\"===c)a=!0;else{if("`"===c){if(s+1<t.length&&"`"===t[s+1]){o(),e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=e.default_fg,e.bg_color=e.default_bg,e.align=e.default_align,s+=2;continue}o(),n="formatting",s++;continue}i+=c}s++}return 0<i.length&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(i)]):l.push([this.stateToStyle(e),i])),l}parseField(e,t,l){var i=t+1,n=e.indexOf("`",i);if(-1===n)return null;i=e.substring(i,n);let a=!1,r=24,o="field",s=i,d="",c=!1;if(i.includes("|")){i=i.split("|");let e=i[0];s=i[1],e.includes("^")?(o="radio",e=e.replace("^","")):e.includes("?")?(o="checkbox",e=e.replace("?","")):e.includes("!")&&(a=!0,e=e.replace("!","")),0<e.length&&(u=parseInt(e,10),isNaN(u)||(r=Math.min(u,256))),2<i.length&&(d=i[2]),3<i.length&&"*"===i[3]&&(c=!0)}var u=e.indexOf(">",n);if(-1===u)return null;i=e.substring(n+1,u),e=this.stateToStyle(l);let p=null;return{obj:p="checkbox"===o||"radio"===o?{type:o,name:s,value:d||i,label:i,prechecked:c,style:e}:{type:"field",name:s,width:r,masked:a,data:i,style:e},skip:u-t}}parseLink(e,t,l){var i=e.indexOf("]",t);if(-1===i)return null;var e=e.substring(t+1,i),n=e.split("`");let a="",r="",o="";if(1===n.length?(a="",r=e):2===n.length?(a=n[0],r=n[1]):3===n.length&&(a=n[0],r=n[1],o=n[2]),0===r.length)return null;""===a&&(a=r),r=MicronParser.formatNomadnetworkUrl(r),this.enableForceMonospace&&(a=this.splitAtSpaces(a));e=this.stateToStyle(l);return{obj:{type:"link",url:r,label:a,fields:o?o.split("|"):[],style:e},skip:i-t}}splitAtSpaces(e){let t="";var l=e.split(/(?<= )/g);for(let e=0;e<l.length;e++)t+="<span class='Mu-mws'>"+this.forceMonospace(l[e])+"</span>";return t}forceMonospace(e){let t="";var l;for(l of[...(new Intl.Segmenter).segment(e)].map(e=>e.segment))t+="<span class='Mu-mnt'>"+l+"</span>";return t}}export default MicronParser;